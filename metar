#!/usr/bin/python

import sys
import getopt
import pymetar
from urllib2 import URLError

DEFAULT = 'KBOS'

if __name__ == '__main__':
    opts, args = getopt.getopt(sys.argv[1:], 'v')

    verbose = False
    for opt, arg in opts:
        if opt == '-v':
            verbose = True

    try:
        station = args[0]
    except IndexError:
        station = DEFAULT

    try:
        f = pymetar.ReportFetcher(station)
        p = pymetar.ReportParser()
        r = p.ParseReport(f.FetchReport())
    except URLError, e:
        print 'Error fetching METAR: %s' % e.args[0]
        sys.exit(1)

    if verbose:
        head = '%s; %s' % (r.getStationCity(), r.getISOTime())
        print head; print '=' * len(head)

        obs = []
        obs.append(('Conditions', r.getWeather()))
        obs.append(('Temperature', r.getTemperatureCelsius()))
        obs.append(('Wind', '%s %s m/s' %
                            (r.getWindCompass(), r.getWindSpeed())))
        obs.append(('Visibility', '%s km' % r.getVisibilityKilometers()))
        obs.append(('Dew Point', '%s' % r.getDewPointCelsius()))
        obs.append(('Humidity', '%s%%' % r.getHumidity()))

        width = max([len(o[0]) for o in obs]) + 2
        for o in obs:
            print '%*s: %s' % (width, o[0], o[1])
    else:
        print r.getWeather(), '(%s C)' % r.getTemperatureCelsius()
